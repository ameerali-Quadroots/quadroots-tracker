<%= render partial: "admin/dashboard/live_state", locals: { departments: User.distinct.pluck(:department).compact.sort } %>

<%
  # === Define today's range (3 AM cutoff) ===
  now = Time.zone.now

  if now.hour < 3
    # Before 3 AM â†’ treat as previous work day
    start_time = (now - 1.day).change(hour: 3)
    end_time = now.change(hour: 3)
  else
    # After 3 AM â†’ treat as current day
    start_time = now.change(hour: 3)
    end_time = (now + 1.day).change(hour: 3)
  end

  # === Today's Summary ===
  @late_time_clocks = TimeClock.where(clock_in: start_time..end_time, status: 'late')
  @on_time_time_clocks = TimeClock.where(clock_in: start_time..end_time, status: 'on_time')

  @late_count = @late_time_clocks.count
  @on_time_count = @on_time_time_clocks.count
  @unique_late_users_today = @late_time_clocks.select(:user_id).distinct.count
%>

<div class="time-summary-container">
  <h2 class="time-summary-title">
    Time Clock Summary for <%= start_time.strftime('%B %d, %Y') %> (Shift Day)
  </h2>

  <div class="time-summary-grid">
    <!-- Users Late Today -->
    <a href="<%= admin_time_clocks_url(
                q: {
                  clock_in_gteq: start_time,
                  clock_in_lteq: end_time,
                  status_eq: 'late'
                },
                commit: 'Filter',
                order: 'id_desc'
              ) %>" class="summary-card summary-late">
      <div class="summary-card-body">
        <h3><%= @unique_late_users_today %></h3>
        <p>Users Late Today</p>
      </div>
    </a>

    <!-- Users On Time Today -->
    <a href="<%= admin_time_clocks_url(
                q: {
                  clock_in_gteq: start_time,
                  clock_in_lteq: end_time,
                  status_eq: 'on_time'
                },
                commit: 'Filter',
                order: 'id_desc'
              ) %>" class="summary-card summary-ontime">
      <div class="summary-card-body">
        <h3><%= @on_time_count %></h3>
        <p>Users On Time Today</p>
      </div>
    </a>
  </div>
</div>

<%
  # === Monthly Summary ===
  month_range = Time.current.beginning_of_month..Time.current.end_of_month
  on_time_month = TimeClock.where(status: "on_time", clock_in: month_range).count
  late_month = TimeClock.where(status: "late", clock_in: month_range).count

  # === Users with more than 3 lates (ordered descending) ===
  late_users = User.joins(:time_clocks)
                   .where(time_clocks: { status: "late", clock_in: month_range })
                   .group("users.id")
                   .having("COUNT(time_clocks.id) > 3")
                   .select("users.*, COUNT(time_clocks.id) as late_count")
                   .order("late_count DESC")
%>

<div class="monthly-stats-container">
  <h2 class="section-title">This Monthâ€™s Attendance Overview</h2>

  <div class="monthly-grid">
    <!-- Monthly On Time -->
    <a href="<%= admin_time_clocks_url(
                q: {
                  clock_in_gteq: month_range.first.to_date,
                  clock_in_lteq: month_range.last.to_date,
                  status_eq: 'on_time'
                },
                commit: 'Filter',
                order: 'id_desc'
              ) %>" class="monthly-card monthly-on-time">
      <div class="monthly-card-body">
        <h3><%= on_time_month %></h3>
        <p>On Time (This Month)</p>
      </div>
    </a>

    <!-- Monthly Late -->
    <a href="<%= admin_time_clocks_url(
                q: {
                  clock_in_gteq: month_range.first.to_date,
                  clock_in_lteq: month_range.last.to_date,
                  status_eq: 'late'
                },
                commit: 'Filter',
                order: 'id_desc'
              ) %>" class="monthly-card monthly-late">
      <div class="monthly-card-body">
        <h3><%= late_month %></h3>
        <p>Late (This Month)</p>
      </div>
    </a>
  </div>

  <div class="late-users-section">
    <h3 class="section-subtitle">Users with More Than 3 Lates (This Month)</h3>

    <% if late_users.any? %>
      <div class="table-wrapper">
        <table class="late-users-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Department</th>
              <th>Late Count</th>
            </tr>
          </thead>
          <tbody>
            <% late_users.each do |user| %>
              <tr>
                <td><%= user.name %></td>
                <td><%= link_to user.email, admin_employee_path(user) %></td>
                <td><%= user.department %></td>
                <td><%= user.late_count %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="no-late-users">
        ðŸŽ‰ No users with more than 3 lates this month!
      </div>
    <% end %>
  </div>
</div>
