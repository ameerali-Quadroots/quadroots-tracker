  
      <%
  start_time = Time.zone.now.beginning_of_day
  end_time = Time.zone.now.end_of_day

  @late_time_clocks = TimeClock.where(clock_in: start_time..end_time, status: 'late')
  @on_time_time_clocks = TimeClock.where(clock_in: start_time..end_time, status: 'on_time')
  %>
 <div class="container mt-5">
  <h2 class="mb-4">Time Clock Summary for <%= Time.zone.today.strftime('%B %d, %Y') %></h2>

  <div class="row">
    <!-- Late Card -->
    <div class="col-md-6">
      <a href="<%= admin_time_clocks_url(
                  q: {
                    clock_in_gteq: Date.today,
                    clock_in_lteq: Date.today + 1,
                    status_eq: 'late'
                  },
                  commit: 'Filter',
                  order: 'id_desc'
                ) %>" class="text-decoration-none">
        <div class="card text-white bg-danger mb-3 shadow-sm" style="cursor: pointer;">
          <div class="card-body text-center">
            <h3 class="card-title"><%= @late_count %></h3>
            <p class="card-text">Users Late Today</p>
          </div>
        </div>
      </a>
    </div>

    <!-- On Time Card -->
    <div class="col-md-6">
      <a href="<%= admin_time_clocks_url(
                  q: {
                    clock_in_gteq: Date.today,
                    clock_in_lteq: Date.today + 1,
                    status_eq: 'on_time'
                  },
                  commit: 'Filter',
                  order: 'id_desc'
                ) %>" class="text-decoration-none">
        <div class="card text-white bg-success mb-3 shadow-sm" style="cursor: pointer;">
          <div class="card-body text-center">
            <h3 class="card-title"><%= @on_time_count %></h3>
            <p class="card-text">Users On Time Today</p>
          </div>
        </div>
      </a>
    </div>
  </div>
</div>
  <%= render partial: "admin/dashboard/live_state", locals: { departments: User.distinct.pluck(:department).compact.sort } %>

  <%# === Dashboard: This Monthâ€™s Attendance Stats === %>
<% month_range = Time.current.beginning_of_month..Time.current.end_of_month %>

<%# Calculate counts %>
<%
  on_time_month = TimeClock.where(status: "on_time", clock_in: month_range).count
  late_month = TimeClock.where(status: "late", clock_in: month_range).count

  late_users = User.joins(:time_clocks)
                   .where(time_clocks: { status: "late", clock_in: month_range })
                   .group("users.id")
                   .having("COUNT(time_clocks.id) > 3")
                   .select("users.*, COUNT(time_clocks.id) as late_count")
%>

<div style="max-width: 1200px; margin: 0 auto;">

  <!-- === Monthly Stats Panel === -->
  <div class="panel" style="margin-bottom: 40px;">
    <h2 style="margin-bottom: 20px;">This Monthâ€™s Stats</h2>

    <div style="display: flex; gap: 30px; justify-content: space-evenly; margin: 20px 0;">
      <!-- On Time (This Month) -->
      <div style="background:#2ecc71; color:white; padding:30px; border-radius:14px; flex:1; text-align:center;">
        <h2 style="font-size:36px; margin-bottom:8px;">
          <%= on_time_month %>
        </h2>
        <span>On Time (This Month)</span>
      </div>

      <!-- Late (This Month) -->
      <div style="background:#e74c3c; color:white; padding:30px; border-radius:14px; flex:1; text-align:center;">
        <h2 style="font-size:36px; margin-bottom:8px;">
          <%= late_month %>
        </h2>
        <span>Late (This Month)</span>
      </div>
    </div>
  </div>

  <!-- === Users with More than 3 Lates === -->
  <div class="panel">
    <h2>Users with More than 3 Lates (This Month)</h2>

    <% if late_users.any? %>
      <table style="width:100%; border-collapse:collapse; margin-top:20px;">
        <thead>
          <tr style="background:#f5f5f5;">
            <th style="padding:10px; text-align:left;">User</th>
            <th style="padding:10px; text-align:left;">Email</th>
            <th style="padding:10px; text-align:left;">Department</th>
            <th style="padding:10px; text-align:left;">Late Count</th>
          </tr>
        </thead>
        <tbody>
          <% late_users.each do |user| %>
            <tr>
              <td style="padding:10px; border-bottom:1px solid #ddd;"><%= user.name %></td>
              <td style="padding:10px; border-bottom:1px solid #ddd;"><%= link_to user.email, admin_employee_path(user) %></td>
              <td style="padding:10px; border-bottom:1px solid #ddd;"><%= user.department %></td>
              <td style="padding:10px; border-bottom:1px solid #ddd;"><%= user.late_count %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div style="padding:15px; text-align:center; color:#555;">
        ðŸŽ‰ No users with more than 3 lates this month!
      </div>
    <% end %>
  </div>

</div>


