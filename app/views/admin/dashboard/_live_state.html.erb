<%# --- Calculate shift range --- %>
<%
now = Time.zone.now
if now.hour < 3
  shift_start = (now - 1.day).change(hour: 17, min: 30)
  shift_end = now.change(hour: 3)
else
  shift_start = now.change(hour: 17, min: 30)
  shift_end = (now + 1.day).change(hour: 3)
end
shift_range = shift_start..shift_end
%>

<% if departments.empty? %>
  <div class="no-dept-message">
    No departments found.
  </div>
<% else %>
  <%
    current_states_by_department = {}

    departments.each do |dept|
      users = User.includes(time_clocks: :breaks).where(department: dept)
      states = users.map do |user|
        last_clock = user.time_clocks.where(clock_in: shift_range).order(clock_in: :desc).first

        state =
          if last_clock.nil?
            "off"
          elsif last_clock.breaks.where(break_out: nil).exists?
            last_break = last_clock.breaks.where(break_out: nil).last
            case last_break.break_type
            when "Meeting" then "meeting"
            when "Downtime" then "downtime"
            else "on_break"
            end
          elsif last_clock.clock_out.nil?
            "working"
          else
            "off"
          end

        { user: user, state: state }
      end

      current_states_by_department[dept] = states
    end
  %>

  <!-- âœ… Wrap all departments in one global scroll container -->
  <div class="departments-container">
    <% departments.each_slice(4) do |dept_group| %>
      <div class="dept-group">
        <% dept_group.each do |dept| %>
          <% states = current_states_by_department[dept] || [] %>
          <div class="dept-card">
            <h3 class="dept-title"><%= dept.upcase %> Department (<%= states.size %> users)</h3>

            <% if states.empty? %>
              <p class="no-users">No users found in this department.</p>
            <% else %>
              <table class="dept-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <% states.each do |row| %>
                    <tr>
                      <td>
                        <%= link_to row[:user].name, admin_employee_path(row[:user]) %>
                      </td>
                      <td>
                        <span class="status_tag <%= row[:state] %>">
                          <%= row[:state].titleize %>
                        </span>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
