<div class="dashboard-container">
  <div class="particles" id="particles-js"></div>
  
  <div class="dashboard-glass">
    <div class="glass-decoration glass-1"></div>
    <div class="glass-decoration glass-2"></div>
    <div class="glass-decoration glass-3"></div>
    
    <!-- Header -->
    <%= render 'dashboard/header' %>

    <!-- Main Content Grid -->
    <div class="row g-4">
      <!-- Current Status Card -->
      <div class="col-xl-6 add-new">
        <div class="dashboard-card h-100">
          <div class="card-body">
            <h6 class="card-title">
              <i class="bi bi-clock-history"></i>
              Current Status
            </h6>
            <%= render 'dashboard/current_status' %>
          </div>
        </div>
      </div>

      <!-- Today's Summary -->
      <div class="col-xl-6">
        <div class="dashboard-card h-100">
          <div class="card-body">
            <h6 class="card-title">
              <i class="bi bi-bar-chart"></i>
              Today's Summary
            </h6>
            <%= render 'dashboard/todays_summary' %>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Section -->
    <div class="row g-4 mt-4">
      <!-- Timesheets -->
      <div class="col-xl-6 add-new-2">
        <div class="dashboard-card">
          <div class="card-body">
            <h6 class="card-title">
              <i class="bi bi-table"></i>
              This Week Timesheets
            </h6>
            <%= render 'dashboard/timesheets' %>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="col-xl-6">
        <div class="dashboard-card">
          <div class="card-body">
            <h6 class="card-title">
              <i class="bi bi-calendar3"></i>
              Calendar
            </h6>
            <div id="calendar" 
                 class="calendar" 
                 data-time-clocks="<%= @time_clocks_current_month.to_json %>">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<%= render 'shared/edit_request_modal' %>
<%= render 'shared/leave_request_modal' %>
<%= render 'shared/manager_leave_modal' if current_user.role == "Manager" %>

<script>
// Enhanced Dashboard JavaScript with Interactive Particles
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Dashboard initialized - DOM fully loaded');
  initializeDashboard();
});

function initializeDashboard() {
  console.log('üéØ Starting dashboard initialization...');
  
  try {
    initializeLiveClock();
    initializeDurationCounter();
    initializeCalendar();
    initializeModalInteractions();
    initializeFlatpickr();
    createEnhancedParticles();
    initializeAnimations();
    initializeParticleInteractions();
    
    console.log('‚úÖ Dashboard initialized successfully');
  } catch (error) {
    console.error('‚ùå Error initializing dashboard:', error);
  }
}

// Enhanced Particle System
function createEnhancedParticles() {
  const particlesContainer = document.getElementById('particles-js');
  if (!particlesContainer) {
    console.log('‚ùå Particles container not found');
    return;
  }

  try {
    // Clear any existing particles
    particlesContainer.innerHTML = '';
    
    // Create different types of particles
    const particleConfigs = [
      { count: 15, type: 'type-1', size: { min: 2, max: 8 }, speed: { min: 20, max: 35 } },
      { count: 10, type: 'type-2', size: { min: 3, max: 6 }, speed: { min: 25, max: 40 } },
      { count: 8, type: 'type-3', size: { min: 4, max: 10 }, speed: { min: 15, max: 30 } },
      { count: 5, type: 'type-4', size: { min: 5, max: 12 }, speed: { min: 30, max: 50 } }
    ];

    let totalParticles = 0;
    
    particleConfigs.forEach(config => {
      for (let i = 0; i < config.count; i++) {
        createParticle(particlesContainer, config);
        totalParticles++;
      }
    });

    // Add some special interactive particles
    createSpecialParticles(particlesContainer, 3);
    
    console.log(`üéä Enhanced particles created: ${totalParticles + 3}`);
    
  } catch (error) {
    console.error('‚ùå Error creating enhanced particles:', error);
  }
}

function createParticle(container, config) {
  const particle = document.createElement('div');
  particle.className = `particle ${config.type} interactive`;
  
  // Random properties with more variation
  const size = Math.random() * (config.size.max - config.size.min) + config.size.min;
  const left = Math.random() * 100;
  const animationDuration = Math.random() * (config.speed.max - config.speed.min) + config.speed.min;
  const animationDelay = Math.random() * 20;
  const animationType = Math.floor(Math.random() * 3) + 1;
  
  // Apply styles
  particle.style.width = `${size}px`;
  particle.style.height = `${size}px`;
  particle.style.left = `${left}vw`;
  particle.style.animationDuration = `${animationDuration}s`;
  particle.style.animationDelay = `${animationDelay}s`;
  particle.style.animationName = `float-particle-${animationType}`;
  
  // Add some random rotation
  particle.style.transform = `rotate(${Math.random() * 360}deg)`;
  
  // Store original duration for reset
  particle.setAttribute('data-original-duration', particle.style.animationDuration);
  
  // Add magnetic effect to some particles
  if (Math.random() > 0.7) {
    particle.classList.add('magnetic');
  }
  
  // Add pulse effect to some particles
  if (Math.random() > 0.8) {
    particle.classList.add('pulse');
  }
  
  container.appendChild(particle);
  
  // Add click interaction
  particle.addEventListener('click', function(e) {
    e.stopPropagation();
    createParticleBurst(this);
  });
}

function createSpecialParticles(container, count) {
  for (let i = 0; i < count; i++) {
    const specialParticle = document.createElement('div');
    specialParticle.className = 'particle type-2 interactive pulse';
    
    const size = 8 + Math.random() * 8;
    const left = Math.random() * 100;
    const animationDuration = 40 + Math.random() * 20;
    
    specialParticle.style.width = `${size}px`;
    specialParticle.style.height = `${size}px`;
    specialParticle.style.left = `${left}vw`;
    specialParticle.style.animationDuration = `${animationDuration}s`;
    specialParticle.style.animationDelay = `${Math.random() * 10}s`;
    specialParticle.style.zIndex = '2';
    
    container.appendChild(specialParticle);
    
    // Store original duration
    specialParticle.setAttribute('data-original-duration', specialParticle.style.animationDuration);
    
    // Special interaction for large particles
    specialParticle.addEventListener('mouseenter', function() {
      this.style.animationPlayState = 'paused';
      this.style.transform = 'scale(1.5)';
      this.style.filter = 'blur(0) brightness(1.5)';
    });
    
    specialParticle.addEventListener('mouseleave', function() {
      this.style.animationPlayState = 'running';
      this.style.transform = '';
      this.style.filter = '';
    });
  }
}

function initializeParticleInteractions() {
  let mouseX = 0;
  let mouseY = 0;
  
  // Track mouse position
  document.addEventListener('mousemove', function(e) {
    mouseX = e.clientX;
    mouseY = e.clientY;
    
    // Create mouse follower particles occasionally
    if (Math.random() > 0.7) {
      createMouseFollower(e.clientX, e.clientY);
    }
    
    // Magnetic effect for particles
    updateMagneticParticles(mouseX, mouseY);
  });
  
  // Click effect
  document.addEventListener('click', function(e) {
    createClickEffect(e.clientX, e.clientY);
  });
  
  // Scroll effect
  let scrollTimeout;
  window.addEventListener('scroll', function() {
    createScrollParticles();
    
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      // Particles slow down after scrolling stops
      document.querySelectorAll('.particle').forEach(particle => {
        particle.style.animationPlayState = 'running';
      });
    }, 100);
  });
}

function createMouseFollower(x, y) {
  const follower = document.createElement('div');
  follower.className = 'mouse-follower';
  follower.style.left = `${x}px`;
  follower.style.top = `${y}px`;
  
  // Random size and color
  const size = 2 + Math.random() * 4;
  const colorVariation = Math.random();
  const color = colorVariation > 0.5 ? 'rgba(255, 255, 255, 0.8)' : 'rgba(131, 107, 203, 0.6)';
  
  follower.style.width = `${size}px`;
  follower.style.height = `${size}px`;
  follower.style.background = color;
  
  document.body.appendChild(follower);
  
  // Remove after animation
  setTimeout(() => {
    if (follower.parentNode) {
      follower.parentNode.removeChild(follower);
    }
  }, 1000);
}

function updateMagneticParticles(mouseX, mouseY) {
  const magneticParticles = document.querySelectorAll('.particle.magnetic');
  const magneticStrength = 30; // pixels
  
  magneticParticles.forEach(particle => {
    const rect = particle.getBoundingClientRect();
    const particleX = rect.left + rect.width / 2;
    const particleY = rect.top + rect.height / 2;
    
    const distance = Math.sqrt(Math.pow(mouseX - particleX, 2) + Math.pow(mouseY - particleY, 2));
    
    if (distance < 150) { // Magnetic field radius
      const force = (1 - distance / 150) * magneticStrength;
      const angle = Math.atan2(mouseY - particleY, mouseX - particleX);
      
      const moveX = Math.cos(angle) * force;
      const moveY = Math.sin(angle) * force;
      
      particle.style.transform = `translate(${moveX}px, ${moveY}px) rotate(${Math.random() * 360}deg)`;
    } else {
      particle.style.transform = `rotate(${Math.random() * 360}deg)`;
    }
  });
}

function createClickEffect(x, y) {
  // Create burst effect
  const burst = document.createElement('div');
  burst.className = 'particle-burst';
  burst.style.left = `${x}px`;
  burst.style.top = `${y}px`;
  burst.style.background = 'radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(131,107,203,0.4) 100%)';
  burst.style.width = '0px';
  burst.style.height = '0px';
  
  document.body.appendChild(burst);
  
  // Remove after animation
  setTimeout(() => {
    if (burst.parentNode) {
      burst.parentNode.removeChild(burst);
    }
  }, 600);
  
  // Create ripple particles
  createRippleParticles(x, y);
}

function createRippleParticles(x, y) {
  const particlesCount = 12;
  
  for (let i = 0; i < particlesCount; i++) {
    setTimeout(() => {
      const particle = document.createElement('div');
      particle.className = 'particle type-1';
      
      const angle = (i / particlesCount) * Math.PI * 2;
      const distance = 50 + Math.random() * 50;
      
      particle.style.width = '4px';
      particle.style.height = '4px';
      particle.style.left = `${x}px`;
      particle.style.top = `${y}px`;
      particle.style.animation = `ripple 1s ease-out forwards`;
      particle.style.animationDelay = `${i * 0.1}s`;
      
      document.body.appendChild(particle);
      
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, 1000);
    }, i * 50);
  }
}

function createParticleBurst(clickedParticle) {
  const rect = clickedParticle.getBoundingClientRect();
  const x = rect.left + rect.width / 2;
  const y = rect.top + rect.height / 2;
  
  const burstParticles = 8;
  
  for (let i = 0; i < burstParticles; i++) {
    const burstParticle = document.createElement('div');
    burstParticle.className = 'particle type-2';
    
    const angle = (i / burstParticles) * Math.PI * 2;
    const distance = 30;
    const size = 3 + Math.random() * 5;
    
    burstParticle.style.width = `${size}px`;
    burstParticle.style.height = `${size}px`;
    burstParticle.style.left = `${x}px`;
    burstParticle.style.top = `${y}px`;
    burstParticle.style.animation = `burst-particle 1s ease-out forwards`;
    
    document.body.appendChild(burstParticle);
    
    setTimeout(() => {
      if (burstParticle.parentNode) {
        burstParticle.parentNode.removeChild(burstParticle);
      }
    }, 1000);
  }
  
  // Make clicked particle disappear and reappear
  clickedParticle.style.opacity = '0';
  setTimeout(() => {
    clickedParticle.style.opacity = '';
  }, 1000);
}

function createScrollParticles() {
  // Speed up particles when scrolling
  document.querySelectorAll('.particle').forEach(particle => {
    if (Math.random() > 0.8) {
      const currentDuration = parseFloat(particle.style.animationDuration);
      particle.style.animationDuration = `${currentDuration * 0.7}s`;
      
      // Return to normal after a delay
      setTimeout(() => {
        const originalDuration = particle.getAttribute('data-original-duration');
        if (originalDuration) {
          particle.style.animationDuration = originalDuration;
        }
      }, 200);
    }
  });
}

function initializeAnimations() {
  try {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          setTimeout(() => {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }, 100);
        }
      });
    }, { threshold: 0.1 });

    const cards = document.querySelectorAll('.dashboard-card');
    cards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      card.style.transition = `all 0.6s ease ${index * 0.1}s`;
      observer.observe(card);
    });
    console.log('üé≠ Animations initialized for', cards.length, 'cards');
  } catch (error) {
    console.error('‚ùå Error initializing animations:', error);
  }
}

function initializeLiveClock() {
  const clockElement = document.getElementById('live-clock');
  if (!clockElement) {
    console.log('‚è∞ Live clock element not found');
    return;
  }

  try {
    const serverTimeString = clockElement.dataset.serverTime;
    if (!serverTimeString) {
      console.log('‚è∞ No server time data found');
      return;
    }

    const serverTime = new Date(serverTimeString);
    let currentTime = new Date(serverTime.getTime());

    function updateClock() {
      const options = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      };
      
      const formatted = currentTime.toLocaleString('en-GB', options);
      clockElement.textContent = formatted;
      currentTime.setSeconds(currentTime.getSeconds() + 1);
    }

    updateClock();
    setInterval(updateClock, 1000);
    console.log('‚è∞ Live clock initialized');
  } catch (error) {
    console.error('‚ùå Error initializing live clock:', error);
  }
}

function initializeDurationCounter() {
  const clockInElement = document.getElementById('clock-in-time');
  const clockDurationElement = document.getElementById('clock-duration');
  
  if (!clockInElement || !clockDurationElement) {
    console.log('‚è±Ô∏è Duration counter elements not found');
    return;
  }

  try {
    const clockInTime = clockInElement.dataset.clockInTime;
    if (!clockInTime) {
      console.log('‚è±Ô∏è No clock-in time data found');
      return;
    }

    const clockInDate = new Date(clockInTime);
    const totalBreakSeconds = parseInt(clockInElement.dataset.breakSeconds) || 0;
    const onBreak = clockInElement.dataset.onBreak === "true";

    function updateDuration() {
      if (onBreak) {
        clockDurationElement.textContent = "On Break";
        clockDurationElement.className = "text-warning fw-bold";
        return;
      }

      const now = new Date();
      const elapsedTime = (now - clockInDate) / 1000;
      const workTime = Math.max(elapsedTime - totalBreakSeconds, 0);

      const hours = Math.floor(workTime / 3600);
      const minutes = Math.floor((workTime % 3600) / 60);
      const seconds = Math.floor(workTime % 60);

      clockDurationElement.textContent = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
      clockDurationElement.className = "live-duration";
    }

    updateDuration();
    setInterval(updateDuration, 1000);
    console.log('‚è±Ô∏è Duration counter initialized');
  } catch (error) {
    console.error('‚ùå Error initializing duration counter:', error);
  }
}

function initializeCalendar() {
  const calendarElement = document.getElementById('calendar');
  if (!calendarElement) {
    console.log('üìÖ Calendar element not found');
    return;
  }

  try {
    const timeClocksData = calendarElement.dataset.timeClocks;
    if (!timeClocksData) {
      console.log('üìÖ No time clocks data found');
      calendarElement.innerHTML = '<div class="text-center text-muted p-4">No calendar data available</div>';
      return;
    }

    const timeClocks = JSON.parse(timeClocksData);
    console.log('üìÖ Loaded time clocks:', timeClocks.length);
    
    const currentDate = new Date();
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), timeClocks, calendarElement);
  } catch (error) {
    console.error('‚ùå Error initializing calendar:', error);
    calendarElement.innerHTML = '<div class="text-center text-muted p-4">Error loading calendar data</div>';
  }
}

function generateCalendar(year, month, timeClocks, calendarElement) {
  try {
    const firstDayOfMonth = new Date(year, month, 1);
    const lastDayOfMonth = new Date(year, month + 1, 0);
    const daysInMonth = lastDayOfMonth.getDate();
    const firstDayOfWeek = firstDayOfMonth.getDay();

    const today = new Date();
    const todayString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    let calendarHtml = '<div class="calendar-header">';
    const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    daysOfWeek.forEach(day => {
      calendarHtml += `<div class="calendar-day">${day}</div>`;
    });
    calendarHtml += '</div>';

    calendarHtml += '<div class="calendar-grid">';

    // Empty cells for days before the 1st
    for (let i = 0; i < firstDayOfWeek; i++) {
      calendarHtml += '<div class="calendar-cell empty"></div>';
    }

    // Calendar days
    for (let day = 1; day <= daysInMonth; day++) {
      const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const dayOfWeek = (firstDayOfWeek + day - 1) % 7;
      const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

      // Find clock entry for this date
      const clockEntry = timeClocks.find(tc => {
        if (!tc.clock_in) return false;
        try {
          const clockInDate = new Date(tc.clock_in);
          const clockInString = `${clockInDate.getFullYear()}-${String(clockInDate.getMonth() + 1).padStart(2, '0')}-${String(clockInDate.getDate()).padStart(2, '0')}`;
          return clockInString === dateString;
        } catch (e) {
          return false;
        }
      });

      let className = '';
      
      if (clockEntry) {
        if (clockEntry.status === 'late') {
          className = 'calendar-late';
        } else if (clockEntry.status === 'on_time') {
          className = 'calendar-on-time';
        }
      } else if (!isWeekend) {
        className = 'calendar-off';
      }

      const calendarDate = new Date(year, month, day);
      if (calendarDate > today) {
        className = 'calendar-future';
      }

      const todayClass = dateString === todayString ? 'today' : '';

      calendarHtml += `<div class="calendar-cell ${className} ${todayClass}" data-date="${dateString}">${day}</div>`;
    }

    calendarHtml += '</div>';
    calendarElement.innerHTML = calendarHtml;

    // Add click event listeners
    const calendarCells = calendarElement.querySelectorAll('.calendar-cell[data-date]');
    calendarCells.forEach(cell => {
      cell.addEventListener('click', function() {
        if (this.classList.contains('calendar-off') || this.classList.contains('calendar-future')) {
          return;
        }
        const selectedDate = this.getAttribute('data-date');
        console.log('üìÖ Navigating to date:', selectedDate);
        window.location.href = `/time_clocks/${selectedDate}`;
      });
    });

    console.log('üìÖ Calendar generated with', calendarCells.length, 'days');
  } catch (error) {
    console.error('‚ùå Error generating calendar:', error);
    calendarElement.innerHTML = '<div class="text-center text-muted p-4">Error generating calendar</div>';
  }
}

function initializeModalInteractions() {
  console.log('üé™ Initializing modal interactions...');
  
  try {
    // Edit request modal interactions
    const requestTypeSelect = document.getElementById("edit_request_request_type");
    const breakReasonContainer = document.getElementById("break_reason_container");

    if (requestTypeSelect && breakReasonContainer) {
      const toggleBreakReason = () => {
        const selectedValue = requestTypeSelect.value;
        const breakReasonSelect = document.getElementById("edit_request_break_reason");
        
        if (selectedValue === "Forgot to end break" || selectedValue === "Forgot to add break") {
          breakReasonContainer.style.display = "block";
          if (breakReasonSelect) {
            breakReasonSelect.setAttribute("required", "required");
            breakReasonSelect.disabled = false;
          }
        } else {
          breakReasonContainer.style.display = "none";
          if (breakReasonSelect) {
            breakReasonSelect.removeAttribute("required");
            breakReasonSelect.disabled = true;
            breakReasonSelect.value = "";
          }
        }
      };

      requestTypeSelect.addEventListener("change", toggleBreakReason);
      // Initialize on page load
      setTimeout(toggleBreakReason, 100);
    }

    // Leave type medical certificate toggle
    const leaveTypeSelect = document.getElementById("leave_leave_type");
    const medicalField = document.getElementById("medical_certificate_field");

    if (leaveTypeSelect && medicalField) {
      const toggleMedicalField = () => {
        const medicalInput = document.getElementById("leave_medical_certificate");
        
        if (leaveTypeSelect.value === "medical") {
          medicalField.style.display = "block";
          if (medicalInput) {
            medicalInput.setAttribute("required", "required");
            medicalInput.disabled = false;
          }
        } else {
          medicalField.style.display = "none";
          if (medicalInput) {
            medicalInput.removeAttribute("required");
            medicalInput.disabled = true;
            medicalInput.value = "";
          }
        }
      };

      leaveTypeSelect.addEventListener("change", toggleMedicalField);
      // Initialize on page load
      setTimeout(toggleMedicalField, 100);
    }

    console.log('‚úÖ Modal interactions initialized');
  } catch (error) {
    console.error('‚ùå Error initializing modal interactions:', error);
  }
}

function initializeFlatpickr() {
  const datetimeFields = document.querySelectorAll(".datetime-field");
  if (datetimeFields.length > 0) {
    if (typeof flatpickr === 'undefined') {
      console.error('üìÖ Flatpickr is not loaded - make sure CDN is included');
      return;
    }

    try {
      const today = new Date();
      const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);

      datetimeFields.forEach(field => {
        flatpickr(field, {
          enableTime: true,
          dateFormat: "Y-m-d H:i",
          time_24hr: false,
          minDate: yesterday,
          minuteIncrement: 1,
          position: "auto"
        });
      });
      console.log('üìÖ Flatpickr initialized on', datetimeFields.length, 'fields');
    } catch (error) {
      console.error('‚ùå Error initializing Flatpickr:', error);
    }
  } else {
    console.log('üìÖ No datetime fields found for Flatpickr');
  }
}

// Add dynamic CSS for particle animations
const particleStyles = document.createElement('style');
particleStyles.textContent = `
  @keyframes ripple {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(var(--ripple-x), var(--ripple-y)) scale(0);
      opacity: 0;
    }
  }
  
  @keyframes burst-particle {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(var(--burst-x), var(--burst-y)) scale(0);
      opacity: 0;
    }
  }
  
  @keyframes scroll-float {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0.8;
    }
    100% {
      transform: translateY(-100px) scale(0);
      opacity: 0;
    }
  }
`;
document.head.appendChild(particleStyles);
</script>